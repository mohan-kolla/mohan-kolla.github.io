<!-- blog/personal-blog.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1QYBJ45BRR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1QYBJ45BRR');
</script>
  <title>Personal Blog – Mohan Kolla</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS: w3.css, Font Awesome, Google Fonts, KaTeX CSS -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.23/dist/katex.min.css"
    integrity="sha384-//SZkxyB7axjCAopkAL1E1rve+ZSPKapD89Lo/lLhcsXR+zOYl5z6zJZEFXil+q0"
    crossorigin="anonymous"
  />

  <style>
    html, body, h1, h2, h3, h4, h5, h6 { font-family: Alice, serif; }
    .topnav { background-color: #333; overflow: hidden; }
    .topnav a {
      float: left; color: #f2f2f2; text-align: center; padding: 14px 16px;
      text-decoration: none; font-size: 17px;
    }
    .topnav a:hover { background-color: #ddd; color: black; }
    .topnav a.active { background-color: #04AA6D; color: white; }
    .topnav button {
      float: right; padding: 14px 16px; margin: 0; background-color: #04AA6D;
      color: #fff; border: none; cursor: pointer; font-size: 17px;
    }
    .topnav button:hover { background-color: #45a049; }

    /* Blog content spacing */
    #blog-entries .w3-card-4 { overflow-wrap: anywhere; }
    textarea#blog-content { min-height: 240px; resize: vertical; }

    /* Simple helper to space footer icons */
    footer .fa { margin: 0 8px; font-size: 20px; }
  </style>
</head>

<body class="w3-light-grey">
  <!-- Navigation Bar -->
  <div class="topnav">
    <a href="/index.html">Home</a>
    <a href="/projects/current-projects.html">Current Projects</a>
    <a href="/blog/personal-blog.html" class="active">Personal Blog</a>
    <button id="logout-btn" class="w3-button w3-green" onclick="logout()" style="display: none;">Logout</button>
    <button id="login-btn" class="w3-button w3-green" onclick="document.getElementById('login-form').style.display='block'">Login</button>
  </div>

  <!-- Blog Entries Container -->
  <div class="w3-content w3-margin-top" style="max-width: 1400px;">
    <div class="w3-container w3-center">
      <button id="add-blog-btn" class="w3-button w3-green" onclick="openBlogForm()" style="display: none;">Add Blog Entry</button>
    </div>
    <div id="blog-entries" class="w3-container"></div>
  </div>

  <!-- Login Modal (client-side demo only; move auth server-side for production) -->
  <div id="login-form" class="w3-modal">
    <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width: 600px;">
      <span onclick="document.getElementById('login-form').style.display='none'" class="w3-button w3-display-topright">&times;</span>
      <div class="w3-center"><h3>Admin Login</h3></div>
      <div class="w3-container">
        <label for="username"><b>Username</b></label>
        <input class="w3-input w3-border" type="text" placeholder="Enter Username" id="username" required />
        <label for="password"><b>Password</b></label>
        <input class="w3-input w3-border" type="password" placeholder="Enter Password" id="password" required />
        <button class="w3-button w3-block w3-green w3-section w3-padding" onclick="login()">Login</button>
        <p class="w3-small w3-text-grey">Note: client-side login is only for demo. Implement server-side auth for production.</p>
      </div>
    </div>
  </div>

  <!-- Add/Edit Blog Modal -->
  <div id="blog-form" class="w3-modal">
    <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width: 700px;">
      <span onclick="document.getElementById('blog-form').style.display='none'" class="w3-button w3-display-topright">&times;</span>
      <div class="w3-center"><h3 id="form-title">Add Blog Entry</h3></div>
      <div class="w3-container">
        <input type="hidden" id="blog-entry-id" />
        <label for="blog-date"><b>Date</b></label>
        <input class="w3-input w3-border" type="date" id="blog-date"/>
        <label for="blog-content"><b>Content (Markdown supported)</b></label>
        <textarea class="w3-input w3-border" placeholder="Write your post in Markdown. Math: $x^2$, $$\\int f(x)dx$$" id="blog-content" required></textarea>
        <button class="w3-button w3-block w3-green w3-section w3-padding" onclick="saveEntry()">Save</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w3-container w3-green w3-center w3-margin-top">
    <p>Find me on social media.</p>
    <a href="https://www.instagram.com/mohankrishna.kolla/" target="_blank" rel="noopener"><i class="fa fa-instagram w3-hover-opacity"></i></a>
    <a href="https://www.linkedin.com/in/mohan-kolla-1b428524b/" target="_blank" rel="noopener"><i class="fa fa-linkedin w3-hover-opacity"></i></a>
  </footer>

  <!-- JS: KaTeX core + auto-render (correct SRI), Marked, DOMPurify -->
  <script defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.23/dist/katex.min.js"
    integrity="sha384-cpAIxua0Xbyc+XrpHQpCtJzGSZ6U2kS/FeyoKjnS+BgAYNV6uVUetVs/LC9+l3rs"
    crossorigin="anonymous"></script>
  <script defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.23/dist/contrib/auto-render.min.js"
    integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

  <script>
    // ====== Config ======
    const API_URL = 'https://mohan-kollagithubio-production.up.railway.app/api/blog-entries';

    // ====== State ======
    let isAdmin = false;
    let editingEntryId = null;

    // ====== Utils ======
    function toMMDDYYYY(iso) {
      // iso: YYYY-MM-DD
      const [y, m, d] = (iso || '').split('-');
      if (!y || !m || !d) return '';
      return `${m}/${d}/${y}`;
    }
    function fromMMDDYYYY(mdy) {
      // mdy: MM/DD/YYYY
      const [m, d, y] = (mdy || '').split('/');
      if (!y || !m || !d) return '';
      return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      const text = await res.text().catch(() => '');
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${text || 'no body'}`);
      }
      return text ? JSON.parse(text) : null;
    }

    // Safe Markdown rendering
    marked.setOptions({ mangle: false, headerIds: false });
    function renderMarkdown(md) {
      const html = marked.parse(md ?? '');
      return DOMPurify.sanitize(html);
    }

    // ====== Admin UI state ======
    function checkAdmin() {
      const addBlogBtn = document.getElementById('add-blog-btn');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      addBlogBtn.style.display = isAdmin ? 'block' : 'none';
      loginBtn.style.display = isAdmin ? 'none' : 'block';
      logoutBtn.style.display = isAdmin ? 'block' : 'none';
    }

    function login() {
      // NOTE: This is only a demo client-side check. Replace with server auth.
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (username === 'EmpMo666' && password === 'LilithKolla21') {
        isAdmin = true;
        localStorage.setItem('isLoggedIn', 'true');
        document.getElementById('login-form').style.display = 'none';
        checkAdmin();
        fetchBlogEntries();
      } else {
        alert('Invalid credentials');
      }
    }

    function logout() {
      isAdmin = false;
      localStorage.removeItem('isLoggedIn');
      checkAdmin();
      fetchBlogEntries();
    }

    function checkLoginState() {
      if (localStorage.getItem('isLoggedIn') === 'true') {
        isAdmin = true;
      }
      checkAdmin();
    }

    // ====== CRUD ======
    async function fetchBlogEntries() {
      try {
        const entries = await fetchJSON(API_URL);
        // Ensure newest first
        (entries || []).reverse();
        renderBlogEntries(entries || []);
      } catch (err) {
        console.error(err);
        alert('Failed to fetch blog entries.\n' + err.message);
      }
    }

    function renderBlogEntries(entries) {
      const blogContainer = document.getElementById('blog-entries');
      blogContainer.innerHTML = '';

      entries.forEach((entry) => {
        const safeHtml = renderMarkdown(entry.content);
        const card = `
          <div class="w3-card-4 w3-margin w3-white">
            <div class="w3-container">
              <h5>${entry.date}</h5>
            </div>
            <div class="w3-container">
              <div id="content-${entry.id}">${safeHtml}</div>
              ${
                isAdmin
                  ? `<div class="w3-section">
                      <button class="w3-button w3-green" onclick="openBlogForm('${entry.id}')">Edit</button>
                      <button class="w3-button w3-red" onclick="deleteEntry('${entry.id}')">Delete</button>
                    </div>`
                  : ''
              }
            </div>
          </div>
        `;
        blogContainer.insertAdjacentHTML('beforeend', card);

        // Render KaTeX math inside the post
        if (window.renderMathInElement) {
          const contentEl = document.getElementById(`content-${entry.id}`);
          renderMathInElement(contentEl, {
            delimiters: [
              { left: '$$', right: '$$', display: true },
              { left: '$', right: '$', display: false }
            ],
            throwOnError: false
          });
        }
      });
    }

    async function openBlogForm(entryId = null) {
      editingEntryId = entryId;
      document.getElementById('form-title').innerText = entryId ? 'Edit Blog Entry' : 'Add Blog Entry';
      document.getElementById('blog-form').style.display = 'block';
      document.getElementById('blog-date').value = '';
      document.getElementById('blog-content').value = '';
      document.getElementById('blog-entry-id').value = entryId || '';

      if (!entryId) return;

      try {
        const entry = await fetchJSON(`${API_URL}/${entryId}`);
        document.getElementById('blog-date').value = fromMMDDYYYY(entry.date);
        document.getElementById('blog-content').value = entry.content;
      } catch (err) {
        console.error('Error loading entry:', err);
        alert('Error loading entry for editing.\n' + err.message);
      }
    }

    async function saveEntry() {
      const dateIso = document.getElementById('blog-date').value; // YYYY-MM-DD
      const content = document.getElementById('blog-content').value;
      const entryId = document.getElementById('blog-entry-id').value;

      if (!dateIso || !content) {
        alert('Please fill in both date and content');
        return;
      }

      const date = toMMDDYYYY(dateIso);
      const payload = { content, date };

      try {
        const url = entryId ? `${API_URL}/${entryId}` : API_URL;
        const method = entryId ? 'PUT' : 'POST';

        await fetchJSON(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        document.getElementById('blog-form').style.display = 'none';
        fetchBlogEntries();
      } catch (err) {
        console.error(err);
        alert(`Error saving entry:\n${err.message}`);
      }
    }

    async function deleteEntry(entryId) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      try {
        await fetchJSON(`${API_URL}/${entryId}`, { method: 'DELETE' });
        fetchBlogEntries();
      } catch (err) {
        console.error(err);
        alert(`Error deleting entry:\n${err.message}`);
      }
    }

    // ====== Init ======
    checkLoginState();
    fetchBlogEntries();
  </script>
</body>
</html>
